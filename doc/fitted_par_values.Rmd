---
title: "fitted_par_value"
author: "Jinyan Yang"
date: "11/08/2020"
output: html_document
---
```{r, echo=FALSE,warning=F,message=F}
tmp.ls <- list()
tmp.ls[[1]] <- data.frame(model='v00',
                          f.h = 222,
                          f.t.opt = 33,
                          t.max = 45,
                          f.extract = 0.519348383 ,
                          f.growth= 0.00227958267,
                          f.sec = 0.0755224228 ,
                          
                          swc.wilt = .12,
                          swc.capacity = .4,
                          bucket.size = 1000,
                          day.lay = 3,
                          
                          q=1)

# 
get.fit.value.func <- function(fn){
  in.chain =  readRDS(fn)
  burnIn = 1
  chain.3.ls.new = lapply(in.chain,function(m.in)m.in[round(nrow(m.in)/3):nrow(m.in),])
  
  chain.fes <- do.call(rbind,chain.3.ls.new)
  
  return( colMeans(chain.fes[burnIn:nrow(chain.fes),]))
}

v10.chain <- get.fit.value.func('cache/smv10chain.Luc.Control.Ambient.rds')
tmp.ls[[2]] <- data.frame(model='v10',
                          f.h = 222,
                          f.t.opt = v10.chain[1],
                          t.max = 45,
                          
                          f.extract = v10.chain[2] ,
                          f.sec = v10.chain[3] ,
                          f.growth= v10.chain[4],
                          
                          
                          swc.wilt = .05,
                          swc.capacity = .13,
                          bucket.size = 300,
                          day.lay = 3,
                          q = 1)

v11.chain <- get.fit.value.func('cache/smv11chain.Luc.Control.Ambient.rds')
tmp.ls[[3]] <- data.frame(model='v11',
                          f.h = 222,
                          f.t.opt = v11.chain[1],
                          t.max = 45,
                          
                          f.extract = v11.chain[2] ,
                          f.sec = v11.chain[3] ,
                          f.growth= v11.chain[4],
                          
                          
                          swc.wilt = .05,
                          swc.capacity = .13,
                          bucket.size = 300,
                          day.lay = 3,
                          
                          q=1)
# 
v13.chain <- get.fit.value.func('cache/smv13chain.Luc.Control.Ambient.rds')
tmp.ls[[4]] <- data.frame(model='v13',
                          f.h = 222,
                          f.t.opt = v13.chain[1],
                          t.max = 45,
                          
                          f.extract = v13.chain[2] ,
                          f.sec = v13.chain[3] ,
                          f.growth= v13.chain[4],
                          
                          
                          swc.wilt = .05,
                          swc.capacity = .13,
                          bucket.size = 300,
                          day.lay = 3,
                          
                          q=v13.chain[5])

out.df = do.call(rbind,tmp.ls)
library(knitr)
```

## 

```{r,warning=FALSE,echo=F,message=F}
kable(t(out.df),caption = 'Table 1. Fitted parameter values for Luc.')
```

## 

## keys: 

f.h MAP based scaling factor

f.t.opt optimal temperature for growth

t.max max temperature for growth

f.extract soil water extraction rate

f.growth growth rate

f.sec senescence rate

swc.wilt swc at wilting point

swc.cap soil water holding capacity

bucket.size soil water bucket size

day.lay delay number of days or number of days plant keeps growing after rainfall

q non-linearity factor in beta function

## Note
Units of parameters can differ by model.

```{r, echo=FALSE,warning=F,message=F}

get.chain.table.func <- function(spceis.in){
  fn <- sprintf('cache/smv13chain.%s.Control.Ambient.rds',spceis.in)
  
  if(file.exists(fn)){
      v10.chain <- get.fit.value.func(fn)
  
  tmp.df <- data.frame(#model='v10',
                          spceies = spceis.in,
                          # f.h = 222,
                          f.t.opt = v10.chain[1],
                          # t.max = 45,
                          
                          f.extract = v10.chain[2] ,
                          f.sec = v10.chain[3] ,
                          f.growth= v10.chain[4],
                          
                          
                          # swc.wilt = .05,
                          # swc.capacity = .13,
                          # bucket.size = 300,
                          # day.lay = 3,
                          q = v10.chain[5])
  }else{
    tmp.df <- NA
  }

  
  return(tmp.df)
}
# 
gcc.met.cw.df <- readRDS('cache/gcc.met.cw.df.rds')

site.vec <- unique(gcc.met.cw.df$Code)
site.vec <- as.character(site.vec)

tmp.ls <- list()
tmp.ls <- lapply(c('Luc','Fes','Rye','Bis','Dig','DigBis',
                   'Pha','PhaSub','Kan','KanWal','Rho','Wal',
                   'ym',site.vec),get.chain.table.func)


out.df.2 = do.call(rbind,tmp.ls)
```

```{r,warning=FALSE,echo=F,message=F}
kable((out.df.2),format = 'html',digits = 4,caption = 'Table 2. Fitted v13 parameter values for Luc, Fes, and Rye. ')


beta.func <- function(x,a=0.05,b=0.13,q=5){
  ((x - a) / (b - a))^q 
}

swc.vec <- seq(0.05,0.13,by=0.001)

beta.luc = beta.func(x=swc.vec,q=6.1)
beta.fes = beta.func(swc.vec,q=1.1)
beta.rye = beta.func(swc.vec,q=1.6)
beta.SCOT = beta.func(swc.vec,q=0.67)

plot(beta.luc~swc.vec,type='l',col='navy',
     xlab='VWC',ylab=expression(beta))

abline(a = -5/8,b=1/0.08,col='grey20')

points(beta.fes~swc.vec,type='l',col='coral')
points(beta.rye~swc.vec,type='l',col='darkseagreen')
points(beta.SCOT~swc.vec,type='l',col='lightskyblue')

legend('topleft',legend = c("Luc","Fes","Rye","SCOT","Linear"),
       lty=1,col=c("navy","coral","darkseagreen","lightskyblue","grey20"),
       bty='n')

```

Fig 1. The shape of beta function for each species.The linear line (in grey) marks the relationship in the original Hufkens model by assuming q = 1.