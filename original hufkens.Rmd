---
title: "original hufkens"
output: html_document
---

We started by implemeting and testing the model presented by Hufkens et al. (2016; refered as V10 here afrer).

## 1. The original Hufken's PhenoGrass Model

Vegetation dynamic equations:

The vegetation cover (V) is a function of growth (G) and senescense (S).

$$V_{t+1} = V_{t} + G_{t} - S_{t} $$

where G is 

$$ G_{t} = {f_{T,t} W_{lag,t} f_{MAP} r_{growth}} (1 - {V_{t} \over V_{max}})  $$
fT,t is the temperature dependent fractor; Wlag,t is lagged soil water availability (mm; 2.5 days ago as Hufkens fitted, taken as 3 in our model); fMAP is the mean annual precipitation dependent fractor; rgrowth is the max growth rate (cover per mm per day); Vmax is the max veg cover. 

And S is:

$$ S_{t} = {d  r_{senescence}} (1 - V_{t}) {V_{t}})  $$

where d is 0 or 1 depending on PAR and SWC; rsenescence is the senescence rate (cover per day). 

We first test the model performance against PACE data during 2018 Oct 1 to 2019 Nov 1. The parameter values are obtained from the paper (https://github.com/khufkens/phenograss-example). The only difference from our test and the original model is that we swiched off the DOY based phenology (equation 9 in his paper) because our plants clearly can grow in the winter. 

We have harest date for the plants, and thus decided to account for harvest in the model. This is achieved by setting the modelled cover to observation after each harvest event.

The following tests use lucerne (control&ambient) as an example.

```{r, echo=FALSE,warning=F,message=F}

# build the pheno grass model as in Hufkens 2016#####
# the Penman equation is a different version 
# here used the equation modified from the evapotranspiration R package
source('r/functions_mcmc_v12.r')
# source('models/hufkens/pG_v10.R')
source('r/plot.mcmc.r')
day.lag <- 3
source('r/pace_data_process.R')
gcc.met.pace.df.16 <- get.pace.func(gcc.met.pace.df,
                                      species.in ="Luc",
                                      prep.in = 'Control',
                                      temp.in ='Ambient')
gcc.met.pace.df.16$map <- 760
```

```{r,echo=FALSE}

hufken.pace.pred <- phenoGrass.func.v10(gcc.met.pace.df.16,
                                    f.h = 222,
                                    f.t.opt = 33,
                                    f.extract = 0.519348383 ,
                                    f.growth= 0.00227958267,
                                    f.sec = 0.0755224228 ,
                                    swc.wilt = .12,
                                    day.lay = 3,
                                    swc.capacity = .4,
                                    t.max = 45,
                                    bucket.size = 1000,
                                    use.smooth = T)

# gcc.met.pace.df.16$cover.hufken <- hufken.pace.pred$cover.pred.vec
# gcc.met.pace.df.16$swc.hufken <- hufken.pace.pred$swc.pred.vec
plot.v10.func <- function(hufken.pace.pred){
  plot(cover~Date,data = hufken.pace.pred,ylim=c(0,0.8),type='b',pch=16,
     xlab='',ylab='cover')

points(cover.hufken~Date,data = hufken.pace.pred,pch=16,col='red')

legend('topright',legend = c('MOD','OBS'),col=c('red','black'),
       pch=16,bty='n')
# plot vwc
plot(vwc~Date,data = hufken.pace.pred,
     # ann=F,axes=F,
     type='s',col='navy',ylim=c(0,0.15),
     xlab='')

par(new=T)

points(vwc.hufken~Date,data = hufken.pace.pred,type='l',col='lightskyblue',lty='dashed')
legend('topright',legend = c('MOD','OBS'),col=c('lightskyblue','navy'),
       lty = c('dashed','solid'),bty='n')
}

plot.v10.func(hufken.pace.pred)

```

Fig 1. Hufkens model performance in PACE: Lucerne (control&ambient). 

V10 captured most of the trends but not on the right scale. The reason could be the soil water capacity and wilting point. Hufkens et al (2016) used the swc.wilt = 0.12 and swc.capacity = 0.4 while assuming  a rooting depth of 1 m. However, the observation from PACE are different (swc.wilt = 0.05, swc.capacity = 0.13 and rooting depth of 30cm). Incorperating PACE values, we have:

```{r,echo=FALSE}
hufken.pace.pred <- phenoGrass.func.v10(gcc.met.pace.df.16,
                                    f.h = 222,
                                    f.t.opt = 33,
                                    f.extract = 0.519348383 ,
                                    f.growth= 0.00227958267,
                                    f.sec = 0.0755224228 ,
                                    swc.wilt = .05,
                                    day.lay = 3,
                                    swc.capacity = .13,
                                    t.max = 45,
                                    bucket.size =300,
                                    use.smooth = T)
plot.v10.func(hufken.pace.pred)
```

Fig 2. Hufekns with PACE soil moisture capacity and wilting point (5% and 13%).

Clearly the modelled cover is much less variable than data. And it only appears to fit the data because after each harvest the modelled cover is set to observations. This issue is better illustrated when harvest is not accounted for.

```{r,echo=FALSE}

gcc.met.pace.df.16$harvest <- 0
hufken.pace.pred <- phenoGrass.func.v10(gcc.met.pace.df.16,
                                    f.h = 222,
                                    f.t.opt = 33,
                                    f.extract = 0.519348383 ,
                                    f.growth= 0.00227958267,
                                    f.sec = 0.0755224228 ,
                                    swc.wilt = .05,
                                    day.lay = 3,
                                    swc.capacity = .13,
                                    t.max = 45,
                                    bucket.size =300,
                                    use.smooth = T)
plot.v10.func(hufken.pace.pred)
```

Fig 3. Plot of original Hukens model fit similar to Fig 2 but without accounting for harvest. 

## 2. Fitting Hufkens to data

Here we fitted the V10 model to PACE data. We switched of the PAR phenology and assumed a rooting depth of 30cm with wilting point and capacity of 5% and 13%. Harvest is also accounted for. 

```{r, echo=FALSE,warning=F,message=F,fig.height=7,fig.width=12}
gcc.met.pace.df.16 <- get.pace.func(gcc.met.pace.df,
                                      species.in ="Luc",
                                      prep.in = 'Control',
                                      temp.in ='Ambient')
gcc.met.pace.df.16$map <- 760
plot.mcmc.func('Luc','Control','Ambient',subplot = NULL,
               nm.note = 'v10',use.smooth = TRUE,
               my.fun =phenoGrass.func.v10 )
```

Fig 4. Fitted to Luc Control and ambient. 


