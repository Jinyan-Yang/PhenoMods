---
title: "max E"
output:
  html_document: default
  pdf_document: default
---
This document shows the adpotation of the maxima E method in Duursama 2008. The goal is to calculate the reduction of plant water avialiability with decreasing soil water content. The advantage of this method is that is is indepedent of phtosytnehsis and environment, and thus can be calcualted daily instead of hourly. 

Let the fun begin.

```{r setup, include=FALSE}
# calculate soil psi
psi.s.func <- function(swc,
                       psi.e = -0.74e-3,#KPa
                       b = 6.4, 
                       swc.sat = 0.38){
   psi.e * (swc / swc.sat)^-b
}

# calculate soil conductivity
k.soil.func <- function(swc,
                        swc.sat = 0.38,
                        psi.e = -0.74e-3,#KPa
                        b = 6.4, 
                        k.sat = 11.4){
  
  # if(swc>swc.sat){
  #   warning(paste0('Given SWC ',swc,' is larger than satureate ',swc.sat,
  #                  '/n A max of ',k.sat,' is given'))
  #   k.s = k.sat
  # }else{
  psi.soil <- psi.s.func(swc = swc,
                         psi.e = psi.e,#KPa
                         b = b, 
                         swc.sat = swc.sat)
  
  k.s <- k.sat * (psi.e / psi.soil)^(2+3/b)
  # }
  
  return(min(k.s,k.sat))
}

# calculate soil conductance
k.s.p.func <- function(swc,
                       r.l=0.48,
                       lai=8,
                       l.v=1490,
                       r.root=0.0005,
                       swc.sat = 0.13,
                       psi.e = -0.74e-3,#KPa
                       b = 6.4, 
                       k.sat = 11.4){
    ks <- r.l*2*pi*
    k.soil.func(swc,swc.sat,psi.e,b,k.sat)/
    lai/log10(1/sqrt(pi * l.v)/r.root)
  
  return(ks)
}

# calculate Emax 
e.frac.func <- function(swc,
                        k.plant = 0.07,
                        swc.sat = 0.13,
                        psi.e = -0.74e-3,#KPa
                        b = 6.4, 
                        k.sat = 11.4,
                        psi.min = -2){
  
  psi.soil <- psi.s.func(swc = swc,
                         psi.e = psi.e,#KPa
                         b = b, 
                         swc.sat = swc.sat)
  
  psi.soil <- max(psi.soil , psi.min)
  
  R.p = 1 / k.plant
  R.s = 1 / k.s.p.func(swc,swc.sat,psi.e,b,k.sat)
  # -R.p * (psi.soil - psi.min)/ psi.min / (R.p + R.s)
  k.l <- 1 / (R.p + R.s)
  e.max <- k.l*(psi.soil - psi.min)
  # 
  R.s.sat <- 1 / k.s.p.func(swc.sat,swc.sat,psi.e,b,k.sat)
  
  k.l.sat <- 1/(R.p + R.s.sat)
  
  e.max.sat <- k.l.sat*(psi.e - psi.min)
  return(e.max/e.max.sat)
}

```

# 1. equatuions
I used Eqn 5-10 from Remko's paper. They are pretty standard plant and soil hydrolic stuffs:

### soil water potential 
$$\psi_{soil} = \psi_{sat}({\theta_{soil} \over \theta_{sat}})^{-b} $$

### soil conductivity
$$ k_s = k_{sat} ({\psi_{soil} \over \psi_{sat}})^{2+3/b} $$


### soil conductance
$$ C_{soil} = {R_l \over LAI} {2 \pi k_s \over log(r_{cyl}/{r_root})}$$

### conductance of the plant soil pathway

$$ {1\over C_{total}} = {1 \over C_{soil} } + {1 \over C_{plant} } $$

### E max
$$ E_{max} = C_{total} (\psi_{soil} - \psi_{plant.min}) $$

### fraction of water available
Since transpiration depends on plant-environment, Remko standarsed the Emax with a theoretical $E_{max.0}$ at $\psi_{soil} = 0$. 

I modified this standardisation by using $E_{max.sat}$ when $\psi_{soil} = \psi_{sat}$:

$$ f_{water.avi} = {E_{max} \over E_{max.sat}} $$
For any given $\theta_{soil}$ the fraction of reduction thus varies between 0 and 1. 0 means no water available and soil is complete dry. 

The above function has been implemented in the empirical model for testing. 

# 2. parameterisation
9 parameters are needed to calculate the fraction. I took their values from Remko's paper. However, those values are esitmated based on pines trees. 

```{r echo=F,results='asis'}
library(knitr)
kable(data.frame(Parameters = c('r.l','LAI','l.v','r.root',
                                  'swc.sat','psi.sat',
                                   'b' ,'k.sat' ,'k.plant'),
                 Values = c(0.48,8,1490,0.0005,0.38,-0.74e-3,6.4,11.4,0.02)))

soil.parm.df = data.frame(soil.type = c('sand','loamy sand','light clay'),
                          b = c(2.79,4.26,11.55),
                          psi.sat.kpa = c(-0.68,-0.36,-4.58),
                          k.sat = c(264.3,79.8,5.5))

```                       


### This is how it work
```{r echo=F,results='asis'}
swc.vec <- seq(0.01,0.13,by=0.001)
fract.vec <- sapply(swc.vec,e.frac.func,
                    b=4.26,
                    k.sat = 79.8,
                    psi.e = -1.38e-3,psi.min = -2)

# frac.t.vec <- sapply(swc.vec,e.frac.func,b = 3,k.plant = .08) /  e.frac.func(0.38,b = 3,k.plant = .08)
frac.sand.vec <- sapply(swc.vec,e.frac.func,b = 2.79,k.sat = 264,psi.e = -0.68e-3) 

frac.clay.vec <- sapply(swc.vec,e.frac.func,b = 11.55,k.sat = 5.5,psi.e = -4.68e-3)

plot(fract.vec~swc.vec,type='l',lwd=3,col='grey',
     xlab=expression(theta[soil]),ylab=expression(f[water.avi]))

points(frac.clay.vec~swc.vec,type='l',lwd=3,col='red')

points(frac.sand.vec~swc.vec,type='l',lwd=3,col='coral')
legend('bottomright',legend = c('Sand','loamy sand','Clay'),lty=1,lwd=2,
       col=c('coral','grey','red'),bty='n')
```

We need to know whether they will work for grasses. 

Logically, and because we are using a fracation instead of absolute values, we should expect that parameters like LAI, root density/fraction/diameter, to be not important. The reduction of k.plant is also not implemented, which we could add later. 

The key parameters thus are soil hydro conductance (k.sat; $k_{sat}$), soil retention curve parameter (b), and saturat soil water content (swc.sat; $\theta_{sat}$).

Let's then explore the sensitivity. In fact Remko did that already in his paper:

<!-- # ```{r,echo=F, out.width = "800px"} -->
<!-- # knitr::include_graphics("Capture.PNG") -->
<!-- # ``` -->

Unless the soil is totaly sand or clay, we should expect something in the middle. For sites with known soil types we could use the parameters asscoaite with the soil type. Otherwise, we could use sandy loam just to be in the middle ground. 

# 3. root distribution

Jackson (1996) proposed a root distribution function: 

$$ f_{root} = \frac{1-\beta ^ {D}} {1 - \beta ^{D_{root}}}  $$
If we use a $\beta$ of 0.943 for grass as in Jackson 1996, and assmue a rooting depth $D_{root}$ of 0.3,0.5, and 1 m, then we can calculate the fraction of root at each depth. 

```{r echo=F,results='asis'}
library(knitr)
s.vec <- seq(0.1,1,by=0.1)
beta = 0.943

rooting.detpth = 1
kable(data.frame(Soil.Depth = s.vec,
                 root.frac.03 = (1-beta^(100*s.vec)) / (1-beta^(100*.3)),
                 root.frac.05 = (1-beta^(100*s.vec)) / (1-beta^(100*0.5)),
                 root.frac.1 = (1-beta^(100*s.vec)) / (1-beta^(100*1))
                 ))

```  

At any rooting depth, the top 20cm soil contains 70% or over root biomass. As a result, although the deep soil could still be wet, if the top is dry then the grass lose 70% of water supply. Natually, top soil dries faster than deep soil. We thus need to account for this fact by adding root biomass. Gday already has this so we do not need to worry about it. I haven't figured out an easy way to implement this in the empirical model. Rightnow I'm test the model with small bucket size (40cm). 

There's exceptions though. Some plants may have higher root biomass in deeper soil to get to ground water. We probably do not need to worry about that for now. 



